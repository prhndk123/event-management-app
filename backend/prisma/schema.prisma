generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id           Int       @id @default(autoincrement())
  name         String
  email        String    @unique
  password     String
  avatar       String?
  role         Role      @default(CUSTOMER)
  referralCode String?
  point        Int?      @default(0)
  deletedAt    DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  organizer        Organizer?
  transactions     Transaction[]
  reviews          Review[]
  coupons          Coupon[]
  points           Point[]
  referredByUserId Int?
  referredBy       User?      @relation("Referral", fields: [referredByUserId], references: [id])
  referrals        User[]     @relation("Referral")

  @@map("users")
}

model Organizer {
  id          Int      @id @default(autoincrement())
  userId      Int      @unique
  name        String
  avatar      String?
  bio         String?
  rating      Float    @default(0)
  totalEvents Int      @default(0)
  totalReviews Int     @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  events   Event[]

  @@map("organizers")
}

model Event {
  id          Int      @id @default(autoincrement())
  organizerId Int
  title       String
  description String   @db.Text
  image       String?
  category    String
  location    String
  venue       String
  startDate   DateTime
  endDate     DateTime
  status      EventStatus @default(DRAFT)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  organizer    Organizer    @relation(fields: [organizerId], references: [id], onDelete: Cascade)
  ticketTypes  TicketType[]
  vouchers     Voucher[]
  transactions Transaction[]
  reviews      Review[]

  @@map("events")
}

model TicketType {
  id           Int    @id @default(autoincrement())
  eventId      Int
  name         String
  description  String @db.Text
  price        Int    @default(0)
  totalSeat    Int
  availableSeat Int
  sold         Int    @default(0)

  // Relations
  event        Event         @relation(fields: [eventId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  @@map("ticket_types")
}

model Voucher {
  id            Int      @id @default(autoincrement())
  eventId       Int
  code          String
  discountAmount Int
  discountType  DiscountType
  startDate     DateTime
  endDate       DateTime
  usageLimit    Int
  usedCount     Int      @default(0)

  // Relations
  event        Event         @relation(fields: [eventId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  @@unique([eventId, code])
  @@map("vouchers")
}

model Coupon {
  id            Int      @id @default(autoincrement())
  userId        Int
  code          String   @unique
  discountAmount Int
  expiredAt     DateTime
  isUsed        Boolean  @default(false)

  // Relations
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions  Transaction[]

  @@map("coupons")
}

model Point {
  id          Int      @id @default(autoincrement())
  userId      Int
  amount      Int
  description String
  expiredAt   DateTime?
  type        PointType
  createdAt   DateTime @default(now())

  // Relations
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("points")
}

model Transaction {
  id              Int      @id @default(autoincrement())
  userId          Int
  eventId         Int
  ticketTypeId    Int
  voucherId       Int?
  couponId        Int?
  ticketQty        Int
  totalPrice      Int
  pointsUsed      Int      @default(0)
  finalPrice      Int
  status          TransactionStatus @default(WAITING_PAYMENT)
  paymentProof    String?
  expiredAt       DateTime
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  event       Event        @relation(fields: [eventId], references: [id], onDelete: Cascade)
  ticketType  TicketType   @relation(fields: [ticketTypeId], references: [id], onDelete: Cascade)
  voucher     Voucher?     @relation(fields: [voucherId], references: [id], onDelete: SetNull)
  coupon      Coupon?      @relation(fields: [couponId], references: [id], onDelete: SetNull)
  review      Review?

  @@map("transactions")
}

model Review {
  id            Int      @id @default(autoincrement())
  userId        Int
  eventId       Int
  transactionId Int      @unique
  rating        Int      @db.SmallInt
  comment       String   @db.Text
  createdAt     DateTime @default(now())

  // Relations
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  event       Event        @relation(fields: [eventId], references: [id], onDelete: Cascade)
  transaction Transaction  @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  @@map("reviews")
}

enum Role {
  CUSTOMER
  ORGANIZER
}

enum EventStatus {
  DRAFT
  PUBLISHED
  CANCELLED
  COMPLETED
}

enum DiscountType {
  PERCENTAGE
  FIXED
}

enum PointType {
  EARNED
  USED
  EXPIRED
}

enum TransactionStatus {
  WAITING_PAYMENT
  WAITING_CONFIRMATION
  DONE
  REJECTED
  EXPIRED
  CANCELLED
}
